import * as turf from "@turf/turf";
import { Feature, LineString, Point, Position } from "geojson";

// Cape Town to Simon's Town train stations coordinates
const CAPE_TOWN_STATION = [18.427190924514157, -33.92363507409255];
const SIMONSTOWN_STATION = [18.42536026729014, -34.18680207313169];

/**
 * Get the pre-defined False Bay Line route from Cape Town to Simon's Town
 * This route follows the exact train tracks with all intermediate points
 */
export function getTrainRouteFromMap(): Feature<LineString> {
  const trainTrackCoordinates: Position[] = [
    [18.427190924514157, -33.92363507409255], // Cape Town
    [18.428902647648055, -33.92430080783585],
    [18.429304978987666, -33.924510016958514],
    [18.430637297405777, -33.92503435865144],
    [18.43293326825048, -33.92540380953064],
    [18.436951217348227, -33.92551954080088],
    [18.442970094188787, -33.92523021232823],
    [18.4461656826218, -33.925019853621805], // Woodstock
    [18.447280785016723, -33.92516150650775],
    [18.45709230819754, -33.92635251782016],
    [18.45836818913526, -33.92668599802791],
    [18.461377264841175, -33.92702594470578],
    [18.462946598197792, -33.92711063753977],
    [18.464708731617275, -33.927532299736754], // Salt River
    [18.465519621220107, -33.927520676614556],
    [18.466384474524414, -33.92774099429868],
    [18.46730243285618, -33.92817533320677],
    [18.467803142432516, -33.928485649999296],
    [18.468416627518465, -33.92906953533476],
    [18.46878652293794, -33.929503703886844],
    [18.469066199962413, -33.9300457033004],
    // [18.471494353786564, -33.938376462892045], // Observatory
    [18.47360477676512, -33.94491453692835],
    [18.473725078695054, -33.94536446341696],
    [18.473865425580605, -33.94632233986675],
    [18.473956584473633, -33.94665562338733], // Mowbray
    [18.473941978433686, -33.94759243570245],
    [18.473916460818128, -33.94804754875043],
    [18.47318331577901, -33.954885407811304], // Rosebank
    [18.47246469611587, -33.96215797319099], // Rondebosch
    [18.47209043096271, -33.96472341110109],
    [18.471988360500486, -33.96534774220134],
    [18.471890480376825, -33.96576364405164],
    [18.471730701559196, -33.96631793934996],
    [18.471334310451386, -33.967214534728846],
    [18.470930813145454, -33.96794735082953],
    [18.469837463527686, -33.96986526658631],
    [18.468084848045706, -33.97290628358492],
    [18.467963793477093, -33.9731731438614],
    [18.467877311972735, -33.97335269759742],
    [18.467778688350315, -33.9736074993201],
    [18.467659202038536, -33.97399913751622],
    [18.467557990295703, -33.974355899365335], // Newlands
    [18.46712165881657, -33.976109226245825],
    [18.46706527231733, -33.97642999697688],
    [18.467049484098204, -33.9767891091178],
    [18.46704430300015, -33.97670548788285],
    [18.46694166286661, -33.980309347055815],
    [18.466947027284473, -33.98040498619731],
    [18.46705431564162, -33.98133913031258],
    // [18.46694750960926, -33.98150092511908], // Claremont
    [18.467394956205542, -33.982517916582445],
    [18.46745664701095, -33.98268472463464],
    [18.46765244826289, -33.98318959501116],
    [18.468003817643577, -33.98384347554641],
    [18.46832568273328, -33.98435945936395],
    [18.47041780575849, -33.987088338891176],
    [18.471258373101943, -33.98835724823596], // Harfield Road
    [18.47184888587277, -33.9894178805732],
    [18.47218684421656, -33.99017178917147],
    [18.472390692112388, -33.99076112311043],
    [18.472567717901814, -33.99150834815231],
    [18.472696463936295, -33.992388997834574],
    // [18.47318526701365, -33.99514979164771], // Kenilworth
    [18.473264157769574, -33.99818821238548],
    [18.473297660136378, -33.999127426877905],
    [18.47313542980098, -34.000704896732046],
    [18.47301900567371, -34.001213934684294],
    [18.472864305129413, -34.001726936064635],
    [18.472377875570483, -34.00283622486527],
    [18.47208282812108, -34.00338755849669],
    [18.47102871324295, -34.00470215303164], // Wynberg
    [18.470784619391324, -34.00558624667622],
    [18.470615565188275, -34.00599874225852],
    [18.470545391742135, -34.006286959153144],
    [18.47026469796102, -34.00823702474582],
    [18.470207283321358, -34.009130734769634],
    [18.47022837631198, -34.01218324106127],
    [18.470265057884337, -34.01247540294047],
    [18.47034639528957, -34.01282837546734],
    [18.47049631128706, -34.01331486701755],
    // [18.47083315372041, -34.01439834853357], // Wittebome
    [18.471020830189108, -34.01465253066997],
    [18.47112859612805, -34.01509250330045],
    [18.47116687255173, -34.015441499088666],
    [18.471168467402702, -34.015771986193855],
    [18.471154113743456, -34.01608793067458],
    [18.4710743711925, -34.01648979977191],
    [18.46970303347331, -34.02196295791691], // Plumstead
    [18.469345766733138, -34.02339230717197],
    [18.469305895458834, -34.02361305202302],
    [18.468922946118955, -34.02933703010663], // Steurhof
    [18.468768302437336, -34.030267092223795],
    [18.468707698100395, -34.03063717304239],
    [18.468583299721516, -34.03112356253214],
    [18.468481229259297, -34.03141698092325],
    [18.467801455562892, -34.03291053384364],
    [18.466880005909776, -34.03531745953799], // Diep River
    [18.466464647148786, -34.03734131768826],
    [18.46635460242175, -34.03788978403254],
    [18.466329084806198, -34.038447497963325],
    [18.466357079493555, -34.04257612197143],
    [18.466344320685778, -34.0427558496355],
    [18.466320397919684, -34.04315098485037],
    [18.46622311201038, -34.0435817990671],
    [18.46618382237176, -34.04377398531533],
    [18.465564267283852, -34.04588052624932], // Heathfield
    [18.46299816231297, -34.05556076792162],
    [18.46288550953788, -34.056178536299925],
    [18.46285064081033, -34.05649630752556],
    [18.462858687437123, -34.056878520244894],
    [18.46375522658097, -34.07565382666856],
    [18.463672560498637, -34.07660575760418], // Steenberg
    [18.46243259395966, -34.08744445150741],
    [18.462440380778197, -34.08846494381364], // Lakeside
    [18.4625297288839, -34.08889987498272],
    [18.462583953815386, -34.08920365982802],
    [18.46279447413763, -34.08982179258236],
    [18.463068788516125, -34.09036595702192],
    [18.46704315725736, -34.096119093121175],
    [18.467291954001837, -34.09666585842531],
    [18.468644868725523, -34.10177100940192],
    [18.468807543527088, -34.10253431577684],
    [18.469145651952648, -34.10450725919678],
    [18.46916479016376, -34.1049879425824],
    [18.46914246224579, -34.10535505609814],
    [18.468951080116003, -34.107589395989194],
    [18.468836250833746, -34.10797498533423],
    [18.467400884911825, -34.110346585180395],
    [18.467235020395883, -34.11069254798284],
    [18.46619517753613, -34.11294787381315],
    [18.46598146751203, -34.113264776600026],
    [18.465713532556446, -34.113576396516],
    [18.46320961642754, -34.115498907603914],
    [18.462128307427, -34.116156459751416],
    [18.46175511231029, -34.11640469095149],
    [18.46135002017506, -34.11673214376052],
    [18.4604664727072, -34.11746626724058],
    [18.45977430740527, -34.117957439813225],
    [18.459493613580374, -34.11819246225719],
    [18.45763720699915, -34.12007261818503],
    [18.456881247660174, -34.12055321312422],
    [18.456495293637822, -34.12078558773444],
    [18.45610615001185, -34.12104436778226],
    [18.45530553479619, -34.121704517394704],
    [18.454387468553787, -34.12223050311254],
    [18.45404012772732, -34.12246763288633],
    [18.45371759697454, -34.12277758102502],
    [18.452966528806407, -34.12364020181251],
    [18.448795510173237, -34.127247429727944],
    [18.448569041325197, -34.12748506674679],
    [18.448307485773316, -34.1278402008156],
    [18.448184682240466, -34.12807915636689],
    [18.448090586030833, -34.128406563975105],
    [18.448055499311998, -34.128784137303995],
    [18.44812726760367, -34.129276564309556],
    [18.448320244579758, -34.12993004881515],
    [18.448353925855713, -34.13025407470869],
    [18.4482979759162, -34.13057748261991],
    [18.44817848960291, -34.13088754486849],
    [18.44751553503377, -34.13180775271842],
    [18.44735621994303, -34.13198672289264],
    [18.44709733292936, -34.13217118736883],
    [18.44684792895506, -34.1323124790348],
    [18.446555851312475, -34.13242315733968],
    [18.446270411761734, -34.13248359862541],
    [18.44520167306771, -34.132524416090654],
    [18.444269821197537, -34.13254118178787],
    [18.44316978846219, -34.13246582646664],
    [18.441958804146946, -34.132322180198244],
    [18.441674694655344, -34.1322653654785],
    [18.439942501521525, -34.13184343496861],
    [18.439723721919986, -34.13180982979321],
    [18.439392169327967, -34.131817297611114],
    [18.43897490911261, -34.13187143927524],
    [18.43864786744021, -34.131964786883685],
    [18.43833210306686, -34.13210480810307],
    [18.4340663310685, -34.134814436286305],
    [18.43373477847648, -34.13514487485053],
    [18.433423524980736, -34.13547531213794],
    [18.433175424401675, -34.13589722451717],
    [18.431692761328396, -34.13900327398378],
    [18.431453682567504, -34.1396454492647],
    [18.43139729606804, -34.140097209185264],
    [18.431428872505375, -34.140414559742894],
    [18.43153036820457, -34.14068337341426],
    [18.431990482023142, -34.14150474319348],
    [18.432371654781136, -34.14179782093209],
    [18.432795681225354, -34.141949026244326],
    [18.43347457462806, -34.14212263200986],
    [18.435556395004255, -34.14332853322787],
    [18.436386404286118, -34.143636538190776],
    [18.43677434341673, -34.143888541419614],
    [18.437054020433127, -34.14419094429029],
    [18.437640440033125, -34.14504401324266],
    [18.43797199263708, -34.14572534220298],
    [18.438847111100877, -34.14693865416148],
    [18.439287383294165, -34.147643051465714],
    [18.43981468348865, -34.14952872629709],
    [18.439810172565906, -34.14978817818001],
    [18.439758296990284, -34.150174554671366],
    [18.43932299323043, -34.15160058596391],
    [18.439149819468224, -34.151955147299645],
    [18.43699496225285, -34.15432202114535],
    [18.436694986078454, -34.154740106530355],
    [18.43627321506686, -34.155440021619285],
    [18.435869487760925, -34.15588049853205],
    [18.435720627394588, -34.15618845773754],
    [18.435565000667726, -34.15680250634353],
    [18.435436439432465, -34.15707126787367],
    [18.435165784255304, -34.157429615224196],
    [18.434705670454132, -34.157767430865256],
    [18.434322242189996, -34.157914874855315],
    [18.433959113160636, -34.15797273254621],
    [18.43347418930156, -34.15799139630901],
    [18.432993776362103, -34.15810337879918],
    [18.432630647219938, -34.158267619522086],
    [18.432251729971913, -34.158588634546454],
    [18.431942731977987, -34.15894137639268],
    [18.430963862351245, -34.160815176138634],
    [18.430923264072636, -34.16118470544512],
    [18.431002205165974, -34.1616288849834],
    [18.431191663805084, -34.16202267246673],
    [18.43156155921387, -34.16240152787106],
    [18.431791616145162, -34.16267587039429],
    [18.43198558569723, -34.16310137946472],
    [18.43240758431843, -34.165820840282045],
    [18.432355708742808, -34.166097037874934],
    [18.432236169356575, -34.1663396431363],
    [18.43178733285445, -34.166908829635695],
    [18.431489345096367, -34.16747144612211],
    [18.431153281570314, -34.16853888663266],
    [18.430778875213086, -34.169003554953605],
    [18.43046311083973, -34.16952980271797],
    [18.430095470875937, -34.17030237329439],
    [18.429186520529537, -34.17131752774574],
    [18.428922631708563, -34.171666484272926],
    [18.428636188312733, -34.17209941227601],
    [18.428442218742873, -34.17256219494246],
    [18.427979849455518, -34.17432186551982],
    [18.427934740259325, -34.17462042739989],
    [18.427914441114496, -34.17484248212336],
    [18.427887375596782, -34.175103722214516],
    [18.42780282758001, -34.17537676362726],
    [18.427739795474885, -34.17551434452506],
    [18.427541312019745, -34.17575954886432],
    [18.427377697265054, -34.175939290965324],
    [18.427169826078934, -34.17615009910714],
    [18.42664679531714, -34.176680445691325],
    [18.426455017360524, -34.17694783674847],
    [18.426300790351466, -34.1772363074672],
    [18.426243122841715, -34.17738387096346],
    [18.425925131283023, -34.17829707500447],
    [18.4258634404794, -34.17851009622417],
    [18.425793703049212, -34.17878857627842],
    [18.42538239230333, -34.18066780033772],
    [18.425102657102308, -34.183439326074186],
    [18.425030237458497, -34.18403508214327],
    [18.425032919667352, -34.184255854735746],
    [18.42504230740303, -34.18461308354377],
    [18.42506206636803, -34.184789776739365],
    [18.425149084493817, -34.185308613801055],
    [18.42536026729014, -34.18680207313169], // Simon's Town
   
  ];


  return turf.lineString(trainTrackCoordinates, {
    name: "False Bay Line",
    route_id: "FB-001",
  });
}

/**
 * Get the total distance of the train route in kilometers
 */
export function getTrainRouteDistance(): number {
  const route = getTrainRouteFromMap();
  return turf.length(route, { units: "kilometers" });
}

/**
 * Get the bounding box of the entire train route
 */
export function getTrainRouteBounds(): number[] {
  const route = getTrainRouteFromMap();
  return turf.bbox(route);
}

/**
 * Find the closest point on the train route to a given coordinate
 */
export function findClosestPointOnRoute(
  coordinate: Position,
): Feature<Point> {
  const route = getTrainRouteFromMap();
  return turf.nearestPointOnLine(route, coordinate);
}

/**
 * Get a point at a specific distance along the train route
 */
export function getPointAtDistance(distanceKm: number): Feature<Point> {
  const route = getTrainRouteFromMap();
  return turf.along(route, distanceKm, { units: "kilometers" });
}

/**
 * Get all stations along the route with their distances from start
 */
export interface TrainStation {
  name: string;
  coordinates: Position;
  distanceFromStart: number;
}

export function getStationsWithDistances(): TrainStation[] {
  const route = getTrainRouteFromMap();
  const routeLength = turf.length(route, { units: "kilometers" });

  // Station coordinates in order
  const stations = [
    { name: "Cape Town station", coords: [18.427190924514157, -33.92363507409255] },
    { name: "Woodstock station", coords: [18.4461656826218, -33.925019853621805] },
    { name: "Salt River station", coords: [18.464708731617275, -33.927532299736754] },
    { name: "Observatory station", coords: [18.471494353786564, -33.938376462892045] },
    { name: "Mowbray station", coords: [18.473956584473633, -33.94665562338733] },
    { name: "Rosebank station", coords: [18.47318331577901, -33.954885407811304] },
    { name: "Rondebosch station", coords: [18.47246469611587, -33.96215797319099] },
    { name: "Newlands station", coords: [18.467557990295703, -33.974355899365335] },
    { name: "Claremont station", coords: [18.46694750960926, -33.98150092511908] },
    { name: "Harfield Rd station", coords: [18.471258373101943, -33.98835724823596] },
    { name: "Kenilworth station", coords: [18.47318526701365, -33.99514979164771] },
    { name: "Wynberg station", coords: [18.47102871324295, -34.00470215303164] },
    { name: "Wittebome station", coords: [18.47122226674652, -34.01432373183546] },
    { name: "Plumstead station", coords: [18.46949945021453, -34.02180440583075] },
    { name: "Steurhof station", coords: [18.468922946118955, -34.02933703010663] },
    { name: "Dieprivier station", coords: [18.466880005909776, -34.03531745953799] },
    { name: "Heathfield station", coords: [18.465564267283852, -34.04588052624932] },
    { name: "Retreat station", coords: [18.46299907310523, -34.05988889150205] },
    { name: "Steenberg station", coords: [18.463672560498637, -34.07660575760418] },
    { name: "Lakeside station", coords: [18.462440380778197, -34.08846494381364] },
    { name: "False Bay station", coords: [18.4686777326298, -34.10244390223332] },
    { name: "Muizenberg station", coords: [18.46797865379426, -34.10959334067815] },
    { name: "St James station", coords: [18.458279780779588, -34.11918190891543] },
    { name: "Kalk Bay station", coords: [18.44993273845162, -34.126182054503516] },
    { name: "Fish Hoek station", coords: [18.432502590303077, -34.13710790112989] },
    { name: "Sunny Cove station", coords: [18.437255596124132, -34.144460014217834] },
    { name: "Glencairn station", coords: [18.43192899612505, -34.16330542386042] },
    { name: "Simon's Town station", coords: [18.42536026729014, -34.18680207313169] },
  ];

  return stations.map((station) => ({
    name: station.name,
    coordinates: station.coords as Position,
    distanceFromStart: turf.distance(
      turf.point(CAPE_TOWN_STATION),
      turf.point(station.coords),
      { units: "kilometers" },
    ),
  }));
}

/**
 * Simplify the train route while preserving accuracy
 */
export function simplifyTrainRoute(tolerance: number = 0.001): Feature<LineString> {
  const route = getTrainRouteFromMap();
  return turf.simplify(route, { tolerance, highQuality: true });
}

/**
 * Get route statistics
 */
export interface RouteStats {
  totalDistance: number;
  numberOfStations: number;
  startStation: string;
  endStation: string;
  boundingBox: number[];
}

export function getRouteStats(): RouteStats {
  return {
    totalDistance: getTrainRouteDistance(),
    numberOfStations: 28,
    startStation: "Cape Town station",
    endStation: "Simon's Town station",
    boundingBox: getTrainRouteBounds(),
  };
}
